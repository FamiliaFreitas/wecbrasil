<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Servi√ßos - WEC Brasil</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .hidden { display: none; }
  </style>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/supabase.min.js"></script>

<script>
   const { createClient } = supabase;
const supabaseClient = createClient(
      'https://xqwubmknwvvonjzaecmk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxd3VibWtud3Z2b25qemFlY21rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwODY2OTQsImV4cCI6MjA2OTY2MjY5NH0._42N0mZO4NcLPcCG9YMB0_hkMTLF5tCdlPZYagN3vIk'
    );
    window.supabaseClient = supabaseClient;
  </script>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Registro de Servi√ßos - WEC Brasil</h1>

    <!-- Login -->
    <div class="card mb-4" id="loginCard">
      <div class="card-header">Login</div>
      <div class="card-body">
        <form id="formLogin">
  <input type="email" id="emailLogin" placeholder="Seu e-mail" required>
  <input type="password" id="senhaLogin" placeholder="Senha" required>
  <button type="submit">Entrar</button>
</form>
        <div class="mt-3">
          <span>N√£o tem conta?</span>
          <button class="btn btn-link p-0" id="btnMostrarCadastro">Cadastre-se</button>
        </div>
      </div>
    </div>

    <script>
      // Login com Supabase
      document.getElementById("formLogin").addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.getElementById("emailLogin").value.trim().toLowerCase();
  const senha = document.getElementById("senhaLogin").value;

  const { data: loginData, error: loginError } = await supabaseClient.auth.signInWithPassword({
    email,
    password: senha
  });

  if (loginError) {
    alert("Erro ao fazer login: " + loginError.message);
    return;
  }

  const user = loginData.user;
  if (!user) {
    alert("Usu√°rio n√£o encontrado ap√≥s login.");
    return;
  }

  const { data: perfil, error: perfilError } = await supabaseClient
    .from("usuarios")
    .select("*")
    .eq("auth_user_id", user.id)
    .single();

  if (perfilError || !perfil) {
    alert("Perfil n√£o encontrado.");
    return;
  }

  window.usuarioAtual = perfil;
  alert(`Bem-vindo, ${perfil.nome}!`);

});
    </script>

<!-- Cadastro individual -->
<div class="card mb-4 hidden" id="cadastroIndividualCard">
  <div class="card-header">Cadastro de Novo Usu√°rio</div>
  <div class="card-body">
    <form id="formCadastroIndividual">
  <input type="text" class="form-control mb-2" id="nomeCadastroIndividual" placeholder="Nome completo" required>
  <input type="email" class="form-control mb-2" id="emailCadastroIndividual" placeholder="Seu e-mail" required>
  <div class="input-group mb-2">
    <input type="password" class="form-control" id="senhaCadastroIndividual" placeholder="Senha" required>
    <button type="button" class="btn btn-outline-secondary" id="toggleCadastroSenha">üëÅÔ∏è</button>
  </div>
  <button type="submit" class="btn btn-success">Cadastrar</button>
  <button type="button" class="btn btn-link" id="btnVoltarLogin">Voltar ao login</button>
</form>
  </div>
</div>

<!-- Cadastro de usu√°rios (somente para admin) -->
<div class="card mb-4 hidden" id="cadastroCard">
  <div class="card-header">Cadastro de Usu√°rio</div>
  <div class="card-body">
    <form id="formMissionario">
      <input type="text" class="form-control mb-2" id="nomeMissionario" placeholder="Nome do usu√°rio" required>
      <input type="email" class="form-control mb-2" id="emailMissionario" placeholder="Email do usu√°rio" required>
      <input type="password" class="form-control mb-2" id="senhaMissionario" placeholder="Senha" required>

      <select class="form-select mb-2" id="tipoUsuario">
        <option value="usuario">Usu√°rio</option>
        <option value="admin">Administrador</option>
      </select>
      <button type="submit" class="btn btn-primary">Cadastrar</button>
    </form>
  </div>
</div>

<!-- Alterar senha -->
<div class="card mb-4 hidden" id="alterarSenhaCard">
  <div class="card-header">Alterar Senha</div>
  <div class="card-body">
    <form id="formAlterarSenha">
      <input type="password" class="form-control mb-2" id="senhaAtual" placeholder="Senha atual" required>
      <input type="password" class="form-control mb-2" id="novaSenha" placeholder="Nova senha" required>
      <button type="submit" class="btn btn-warning">Alterar Senha</button>
    </form>
  </div>
</div>

<script>
  // Mostrar/ocultar senha
  document.getElementById("toggleCadastroSenha").addEventListener("click", () => {
    const senhaInput = document.getElementById("senhaCadastroIndividual");
    senhaInput.type = senhaInput.type === "password" ? "text" : "password";
  });

  // Voltar para login
  document.getElementById("btnVoltarLogin").addEventListener("click", () => {
    document.getElementById("cadastroIndividualCard").classList.add("hidden");
    document.getElementById("loginCard").classList.remove("hidden");
  });

  // Cadastro por admin
  document.getElementById('formMissionario').addEventListener('submit', async (e) => {
  e.preventDefault();

  const nome = document.getElementById('nomeMissionario').value.trim();
  const email = document.getElementById('emailMissionario').value.trim().toLowerCase();
  const senha = document.getElementById('senhaMissionario').value;
  const tipo = document.getElementById('tipoUsuario').value;

  const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
    email,
    password: senha,
  });

  if (signUpError) {
    alert('Erro ao cadastrar usu√°rio: ' + signUpError.message);
    return;
  }

  const user = signUpData.user;
  if (!user) {
    alert('Erro: usu√°rio n√£o retornado ap√≥s cadastro.');
    return;
  }

  const { error: insertError } = await supabaseClient
    .from('usuarios')
    .insert([{ auth_user_id: user.id, email: email, nome: nome, admin: tipo === 'admin' }]);

  if (insertError) {
    alert('Erro ao salvar na tabela usuarios: ' + insertError.message);
    return;
  }

  alert('Usu√°rio cadastrado com sucesso!');
  document.getElementById('formMissionario').reset();
});

  // Alterar senha
  document.getElementById("formAlterarSenha").addEventListener("submit", async (e) => {
    e.preventDefault();
    const novaSenha = document.getElementById("novaSenha").value;

    const { error } = await supabaseClient.auth.updateUser({ password: novaSenha });

    if (error) {
      alert("Erro ao alterar senha: " + error.message);
    } else {
      alert("Senha alterada com sucesso!");
      document.getElementById("formAlterarSenha").reset();
    }
  });
</script>

<!-- Registro de uso de servi√ßos -->
<div class="card mb-4 hidden" id="registroCard">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Registro de Uso</span>
    <div>
      <button class="btn btn-outline-secondary btn-sm" onclick="mostrarAlterarSenha()">Alterar Senha</button>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>
  </div>
  <div class="card-body">
    <form id="formUso">
      <div class="mb-2"><strong>Usu√°rio logado:</strong> <span id="usuarioLogado"></span></div>
      <label>Servi√ßo:</label>
      <select id="tipoServico" class="form-select mb-2" required onchange="mostrarCamposServico()">
        <option value="">Selecione</option>
        <option value="lavanderia">Lavanderia</option>
        <option value="carro">Uso do Carro</option>
        <option value="xerox">Xerox</option>
        <option value="refeicoes">Refei√ß√µes</option>
        <option value="hospedagem">Hospedagem</option>
      </select>
      <div id="detalhesServico" class="mb-3"></div>
      <button type="submit" class="btn btn-success">Registrar Uso</button>
    </form>
  </div>
</div>

<script>
  let usuarioAtual = null;

  async function carregarUsuarioLogado() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (data?.user) {
      usuarioAtual = data.user;
      const { data: perfil } = await supabaseClient
        .from("usuarios")
        .select("nome")
        .eq("auth_user_id", usuarioAtual.id)
        .single();

      document.getElementById("usuarioLogado").textContent = perfil?.nome || usuarioAtual.email;
    }
  }

  function mostrarAlterarSenha() {
    document.getElementById("alterarSenhaCard").classList.remove("hidden");
    document.getElementById("registroCard").classList.add("hidden");
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    location.reload();
  }

  function mostrarCamposServico() {
    const tipo = document.getElementById("tipoServico").value;
    const container = document.getElementById("detalhesServico");
    container.innerHTML = "";

    switch (tipo) {
      case "lavanderia":
        container.innerHTML = `
          <label>Quantidade de lavagens:</label>
          <input type="number" class="form-control mb-2" id="qtdLavagens" required>
          <label>Quantidade de secagens:</label>
          <input type="number" class="form-control mb-2" id="qtdSecagens">
          <label>Data:</label>
          <input type="date" class="form-control" id="dataLavanderia" value="${new Date().toISOString().split("T")[0]}">
        `;
        break;
      case "carro":
        container.innerHTML = `
          <label>Kilometragem inicial:</label>
          <input type="number" class="form-control mb-2" id="kmInicial" required>
          <label>Kilometragem final:</label>
          <input type="number" class="form-control mb-2" id="kmFinal" required>
          <label>Uso pessoal ou departamento:</label>
          <input type="text" class="form-control" id="usoCarro" required>
        `;
        break;
      case "xerox":
        container.innerHTML = `
          <label>Quantidade de c√≥pias:</label>
          <input type="number" class="form-control" id="qtdXerox" required>
        `;
        break;
      case "refeicoes":
        container.innerHTML = `
          <label>Data:</label>
          <input type="date" class="form-control mb-2" id="dataRefeicao" required>
          <label>Quantidade:</label>
          <input type="number" class="form-control" id="qtdRefeicoes" required>
        `;
        break;
      case "hospedagem":
        container.innerHTML = `
          <label>Nome do h√≥spede:</label>
          <input type="text" class="form-control mb-2" id="nomeHospede" required>
          <label>Quantidade de dias:</label>
          <input type="number" class="form-control" id="qtdDias" required>
        `;
        break;
    }
  }
  </script>

  <script>
document.getElementById("formUso").addEventListener("submit", async (e) => {
  e.preventDefault();

  const tipo = document.getElementById("tipoServico").value;
  const campos = {};
  let valido = true;

  switch (tipo) {
    case "lavanderia":
      campos.qtdLavagens = parseInt(document.getElementById("qtdLavagens").value);
      campos.qtdSecagens = parseInt(document.getElementById("qtdSecagens")?.value || 0);
      campos.data = document.getElementById("dataLavanderia")?.value || new Date().toISOString().split("T")[0];

      if (!campos.qtdLavagens && campos.qtdLavagens !== 0) {
        alert("Informe a quantidade de lavagens.");
        valido = false;
      }
      break;

    case "carro":
      campos.kmInicial = parseInt(document.getElementById("kmInicial").value);
      campos.kmFinal = parseInt(document.getElementById("kmFinal").value);
      campos.uso = document.getElementById("usoCarro").value.trim();
      campos.qtdTag = parseInt(document.getElementById("qtdTag")?.value || 0);
      campos.data = document.getElementById("dataCarro")?.value || new Date().toISOString().split("T")[0];

      if (isNaN(campos.kmInicial) || isNaN(campos.kmFinal)) {
        alert("Informe os valores de km inicial e final.");
        valido = false;
      } else if (campos.kmFinal < campos.kmInicial) {
        alert("A quilometragem final n√£o pode ser menor que a inicial.");
        valido = false;
      }

      if (campos.uso === "departamento") {
        const departamento = document.getElementById("departamento").value.trim();
        if (!departamento) {
          alert("Informe o departamento.");
          valido = false;
        } else {
          campos.departamento = departamento;
        }
      }
      break;

    case "xerox":
      campos.qtdXerox = parseInt(document.getElementById("qtdXerox").value);
      campos.data = document.getElementById("dataXerox")?.value || new Date().toISOString().split("T")[0];
      if (!campos.qtdXerox) {
        alert("Informe a quantidade de c√≥pias.");
        valido = false;
      }
      break;

    case "refeicoes":
      const dias = [];
      let erro = false;
      document.querySelectorAll(".linha-dia").forEach((linha) => {
        const data = linha.querySelector(".data-refeicao")?.value;
        const qtd = parseInt(linha.querySelector(".qtd-refeicao")?.value || 0);
        if (!data || !qtd) erro = true;
        else dias.push({ data, qtd });
      });

      if (erro || dias.length === 0) {
        alert("Preencha todos os dias e quantidades de refei√ß√µes.");
        valido = false;
      } else {
        campos.dias = dias;
      }
      break;

    case "hospedagem":
      const entrada = document.getElementById("entradaHospedagem")?.value || document.getElementById("entrada")?.value;
      const saida = document.getElementById("saidaHospedagem")?.value || document.getElementById("saida")?.value;
      if (!entrada || !saida) {
        alert("Informe as datas de entrada e sa√≠da.");
        valido = false;
      } else if (new Date(saida) < new Date(entrada)) {
        alert("Data de sa√≠da n√£o pode ser anterior √† entrada.");
        valido = false;
      } else {
        campos.entrada = entrada;
        campos.saida = saida;
      }
      break;

    default:
      valido = false;
  }

  if (!valido || !usuarioAtual || !usuarioAtual.email) {
  alert("Erro ao registrar uso. Verifique os campos.");
  return;
}

  const { error } = await supabaseClient.from("registros").insert([{
   auth_user_id: usuarioAtual.id,
    tipo_servico: tipo,
    dados: campos,
    data_registro: new Date().toISOString()
  }]);

  if (error) {
    alert("Erro ao salvar no banco: " + error.message);
  } else {
    alert("Servi√ßo registrado com sucesso!");
    document.getElementById("formUso").reset();
    document.getElementById("detalhesServico").innerHTML = "";
    document.getElementById("tipoServico").value = "";
  }
});

  // Chamar ap√≥s login
  carregarUsuarioLogado();
</script>

<!-- √Årea para relat√≥rios (somente admin) -->
<div class="card hidden" id="relatorioCard">
  <div class="card-header">Relat√≥rio Atual</div>
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <div>
      <label for="dataInicial" class="form-label">De:</label>
      <input type="date" class="form-control" id="dataInicial">
    </div>
    <div>
      <label for="dataFinal" class="form-label">At√©:</label>
      <input type="date" class="form-control" id="dataFinal">
    </div>
  </div>
  <div class="card-body">
    <button class="btn btn-info" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
    <pre id="relatorio" class="mt-3"></pre>
  <div class="mt-3">
    <button class="btn btn-danger" onclick="baixarRelatorioPDF()">üìÑ Baixar PDF</button>
    <button class="btn btn-success" onclick="baixarRelatorioCSV()">üìä Baixar Excel (CSV)</button>
  </div>
  </div>
</div>

<!-- Relat√≥rio de refei√ß√µes por per√≠odo -->
<div class="card hidden" id="refeicoesCard">
  <div class="card-header">Relat√≥rio de refei√ß√µes por per√≠odo</div>
  <div class="card-body">
    <div class="mb-2 d-flex gap-2 flex-wrap">
      <div>
        <label for="dataRefInicio" class="form-label">De:</label>
        <input type="date" class="form-control" id="dataRefInicio">
      </div>
      <div>
        <label for="dataRefFim" class="form-label">At√©:</label>
        <input type="date" class="form-control" id="dataRefFim">
      </div>
    </div>
    <button class="btn btn-success mb-2" onclick="gerarRelatorioRefeicoesPeriodo()">Gerar Relat√≥rio</button>
    <pre id="relatorioRefeicoesPeriodo" class="bg-light p-2 rounded"></pre>
    <a id="whatsappLinkRefeicoes" class="btn btn-outline-success" href="#" target="_blank" style="display: none;">Compartilhar via WhatsApp</a>
  </div>
</div>

<!-- Gerenciar usu√°rios -->
<div class="card hidden" id="gerenciarUsuariosCard">
  <div class="card-header">Gerenciar Usu√°rios</div>
  <div class="card-body">
    <ul id="listaUsuarios" class="list-group"></ul>
  </div>
</div>

<script>
  async function gerarRelatorio() {
    const inicio = document.getElementById("dataInicial").value;
    const fim = document.getElementById("dataFinal").value;

    const { data, error } = await supabaseClient
      .from("registros")
      .select("*")
      .gte("data_registro", inicio)
      .lte("data_registro", fim);

    if (error) {
      alert("Erro ao buscar registros: " + error.message);
      return;
    }

    let relatorioTexto = "RELAT√ìRIO DE USO DE SERVI√áOS\n\n";
    data.forEach(item => {
      relatorioTexto += `Usu√°rio: ${item.email_usuario}\n`;
      relatorioTexto += `Servi√ßo: ${item.tipo_servico}\n`;
      relatorioTexto += `Data: ${new Date(item.data_registro).toLocaleString()}\n`;
      relatorioTexto += `Detalhes: ${JSON.stringify(item.dados, null, 2)}\n\n`;
    });

    document.getElementById("relatorio").textContent = relatorioTexto;
  }

  async function gerarRelatorioRefeicoesPeriodo() {
    const inicio = document.getElementById("dataRefInicio").value;
    const fim = document.getElementById("dataRefFim").value;

    const { data, error } = await supabaseClient
      .from("registros")
      .select("*")
      .eq("tipo_servico", "refeicoes")
      .gte("dados->>data", inicio)
      .lte("dados->>data", fim);

    if (error) {
      alert("Erro ao buscar refei√ß√µes: " + error.message);
      return;
    }

    let total = 0;
    let relatorio = "RELAT√ìRIO DE REFEI√á√ïES\n\n";
    data.forEach(item => {
      const nome = item.email_usuario;
      const dataRef = item.dados.data;
      const qtd = parseInt(item.dados.qtdRefeicoes || 0);
      total += qtd;

      relatorio += `Data: ${dataRef} | Usu√°rio: ${nome} | Quantidade: ${qtd}\n`;
    });

    relatorio += `\nTotal de refei√ß√µes: ${total}`;
    document.getElementById("relatorioRefeicoesPeriodo").textContent = relatorio;

    // WhatsApp
    const textoWhats = encodeURIComponent(relatorio);
    const link = `https://wa.me/?text=${textoWhats}`;
    const whatsappBtn = document.getElementById("whatsappLinkRefeicoes");
    whatsappBtn.href = link;
    whatsappBtn.style.display = "inline-block";
  }

  async function carregarUsuarios() {
    const { data, error } = await supabaseClient
      .from("usuarios")
      .select("id, nome, email, tipo");

    if (error) {
      alert("Erro ao carregar usu√°rios: " + error.message);
      return;
    }

    const lista = document.getElementById("listaUsuarios");
    lista.innerHTML = "";

    data.forEach(usuario => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div>
          <strong>${usuario.nome}</strong> (${usuario.email}) - ${usuario.tipo}
        </div>
        <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${usuario.id}, '${usuario.email}')">Excluir</button>
      `;
      lista.appendChild(li);
    });
  }

  async function excluirUsuario(id, email) {
    if (confirm(`Deseja excluir o usu√°rio ${email}?`)) {
      const { error } = await supabaseClient.from("usuarios").delete().eq("id", id);
      if (error) {
        alert("Erro ao excluir usu√°rio: " + error.message);
      } else {
        alert("Usu√°rio exclu√≠do!");
        carregarUsuarios();
      }
    }
  }
</script>

<script>
  async function logout() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
      alert("Erro ao sair: " + error.message);
    } else {
      location.reload(); // ou redireciona para a tela de login, se preferir
    }
  }
</script>

<script>
function mostrarCamposServico() {
  const tipo = document.getElementById('tipoServico').value;
  const detalhes = document.getElementById('detalhesServico');
  detalhes.innerHTML = '';

  const hoje = new Date().toISOString().split('T')[0];

  if (tipo === 'lavanderia') {
    detalhes.innerHTML = `
      <label>Data:</label>
      <input type="date" class="form-control mb-2" id="dataLavanderia">
      <label>Quantidade de lavagens:</label>
      <input type="number" class="form-control mb-2" id="qtdLavagens" min="0" value="">
      <label>Quantidade de secagens:</label>
      <input type="number" class="form-control mb-2" id="qtdSecagens" min="0" value="">
    `;
  } else if (tipo === 'carro') {
    detalhes.innerHTML = `
      <label>Data:</label>
      <input type="date" class="form-control mb-2" id="dataCarro">
      <label>Kilometragem inicial:</label>
      <input type="number" class="form-control mb-2" id="kmInicial" min="0" value="">
      <label>Kilometragem final:</label>
      <input type="number" class="form-control mb-2" id="kmFinal" min="0" value="">
      <label>Uso:</label>
      <select class="form-select mb-2" id="usoCarro" onchange="mostrarCampoDepartamento()">
        <option value="pessoal">Pessoal</option>
        <option value="departamento">Departamento</option>
      </select>
      <div id="campoDepartamento"></div>
      <label>Quantidade de uso da TAG:</label>
      <input type="number" class="form-control mb-2" id="qtdTag" min="0" value="">
    `;
  } else if (tipo === 'xerox') {
    detalhes.innerHTML = `
      <label>Data:</label>
      <input type="date" class="form-control mb-2" id="dataXerox">
      <label>Quantidade de c√≥pias:</label>
      <input type="number" class="form-control mb-2" id="qtdXerox" min="1" value="">
    `;
  } else if (tipo === 'refeicoes') {
    detalhes.innerHTML = `
      <label>Selecionar dias e quantidades:</label>
      <div id="diasRefeicoes" class="mb-2"></div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="adicionarDiaRefeicao()">Adicionar Dia</button>
    `;
  } else if (tipo === 'hospedagem') {
    detalhes.innerHTML = `
      <label>Data de entrada:</label>
      <input type="date" class="form-control mb-2" id="entrada">
      <label>Data de sa√≠da:</label>
      <input type="date" class="form-control mb-2" id="saida" onchange="validarHospedagem()">
      <div id="erroData" class="text-danger"></div>
    `;
  }
}

    function adicionarDiaRefeicao() {
  const diasContainer = document.getElementById('diasRefeicoes');
  const index = diasContainer.children.length;
  const novoDia = document.createElement('div');
  novoDia.classList.add('mb-2', 'linha-dia');
  novoDia.innerHTML = `
    <div class="d-flex align-items-center">
      <input type="date" class="form-control me-2 data-refeicao" required>
      <input type="number" class="form-control qtd-refeicao" placeholder="Quantidade" min="1" required>
      <button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">X</button>
    </div>
  `;
  diasContainer.appendChild(novoDia);
    }

    function validarHospedagem() {
      const entrada = document.getElementById('entrada').value;
      const saida = document.getElementById('saida').value;
      const erro = document.getElementById('erroData');
      if (entrada && saida && saida < entrada) {
        erro.textContent = 'A data de sa√≠da n√£o pode ser anterior √† entrada.';
      } else {
        erro.textContent = '';
      }
    }
  </script>


<script>
  function mostrarCampoDepartamento() {
    const uso = document.getElementById('usoCarro').value;
    const campo = document.getElementById('campoDepartamento');
    if (uso === 'departamento') {
      campo.innerHTML = `
        <label>Departamento:</label>
        <input type="text" class="form-control mb-2" id="departamento">
      `;
    } else {
      campo.innerHTML = '';
    }
  }
</script>

<script>
  async function gerarRelatorio() {
    const { data: registros, error } = await supabaseClient
      .from('registros')
      .select('*');

    if (error) {
      console.error('Erro ao buscar registros:', error);
      document.getElementById('relatorio').textContent = 'Erro ao carregar os registros.';
      return;
    }

    const dataInicial = document.getElementById('dataInicial').value;
    const dataFinal = document.getElementById('dataFinal').value;

    let inicio = dataInicial ? new Date(dataInicial) : null;
    let fim = dataFinal ? new Date(dataFinal) : null;

    const filtrados = registros.filter(reg => {
      const data = new Date(reg.data || reg.entrada);
      if (inicio && data < inicio) return false;
      if (fim && data > fim) return false;
      return true;
    });

    if (filtrados.length === 0) {
      document.getElementById('relatorio').textContent = 'Nenhum registro encontrado no per√≠odo selecionado.';
      return;
    }

    const resumo = {};
    filtrados.forEach(reg => {
      const nome = reg.usuario;
      if (!resumo[nome]) {
        resumo[nome] = {
          lavanderia: 0,
          carroPessoal: 0,
          carroDepartamento: {},
          carroTag: 0,
          carroTagPorDepartamento: {},
          xerox: 0,
          refeicoes: 0,
          hospedagemDias: 0
        };
      }

      switch (reg.tipo) {
        case 'lavanderia':
          resumo[nome].lavanderia += parseInt(reg.qtdLavagens || 0);
          break;

        case 'carro':
          const qtdTag = parseInt(reg.qtdTag || 0);
          if (reg.uso === 'departamento') {
            const depto = reg.departamento || 'N√£o especificado';
            if (!resumo[nome].carroDepartamento[depto]) resumo[nome].carroDepartamento[depto] = 0;
            resumo[nome].carroDepartamento[depto] += parseInt(reg.km || 0);
            if (!resumo[nome].carroTagPorDepartamento[depto]) resumo[nome].carroTagPorDepartamento[depto] = 0;
            resumo[nome].carroTagPorDepartamento[depto] += qtdTag;
          } else {
            resumo[nome].carroPessoal += parseInt(reg.km || 0);
            resumo[nome].carroTag += qtdTag;
          }
          break;

        case 'xerox':
          resumo[nome].xerox += parseInt(reg.qtd || 0);
          break;

        case 'refeicoes':
          reg.dias?.forEach(dia => {
            const data = new Date(dia.data);
            if ((inicio && data < inicio) || (fim && data > fim)) return;
            resumo[nome].refeicoes += parseInt(dia.qtd || 0);
          });
          break;

        case 'hospedagem':
          const entrada = new Date(reg.entrada);
          const saida = new Date(reg.saida);
          if ((inicio && saida < inicio) || (fim && entrada > fim)) return;
          const dias = Math.ceil((saida - entrada) / (1000 * 60 * 60 * 24));
          if (dias > 0) resumo[nome].hospedagemDias += dias;
          break;
       }
    });

    // Exibe o resumo na tela (pode adaptar esse trecho para tabela ou texto formatado)
    let html = '<ul class="list-group">';
    for (let nome in resumo) {
      const r = resumo[nome];
      html += `<li class="list-group-item"><strong>${nome}</strong><br>`;
      html += `Lavanderia: ${r.lavanderia}<br>`;
      html += `Carro (uso pessoal): ${r.carroPessoal} km, TAGs: ${r.carroTag}<br>`;
      html += `Carro (por departamento): ${Object.entries(r.carroDepartamento).map(([dep, km]) => `${dep}: ${km} km`).join(', ')}<br>`;
      html += `TAGs por departamento: ${Object.entries(r.carroTagPorDepartamento).map(([dep, qtd]) => `${dep}: ${qtd}`).join(', ')}<br>`;
      html += `Xerox: ${r.xerox}<br>`;
      html += `Refei√ß√µes: ${r.refeicoes}<br>`;
      html += `Hospedagem: ${r.hospedagemDias} dias<br>`;
      html += '</li>';
    }
    html += '</ul>';

    document.getElementById('relatorio').innerHTML = html;
  }
</script>

<script>
document.getElementById('formUso').addEventListener('submit', async function(e) {
  e.preventDefault();

  const tipo = document.getElementById('tipoServico').value;
  if (!tipo) return alert('Selecione um tipo de servi√ßo.');

  const usuario = usuarioAtual.nome;
  const hoje = new Date().toISOString().split('T')[0];
  const registro = { tipo, usuario, data: hoje };

  // Valida√ß√£o e preenchimento por tipo (mantido como antes)
  // ...

  // ‚úÖ Confirma√ß√£o antes de registrar
  if (!confirm('Deseja registrar este uso de servi√ßo?')) return;

  // Envio para Supabase
  const { error } = await supabaseClient
    .from('registros')
    .insert([registro]);

  if (error) {
    console.error(error);
    alert('Erro ao registrar servi√ßo no banco de dados.');
  } else {
    alert('Registro salvo com sucesso!');
    document.getElementById('formUso').reset();
    document.getElementById('detalhesServico').innerHTML = '';
  }
});

// üìä Gera√ß√£o de relat√≥rio de refei√ß√µes por per√≠odo
async function gerarRelatorioRefeicoesPeriodo() {
  const dataInicial = document.getElementById('dataRefInicio').value;
  const dataFinal = document.getElementById('dataRefFim').value;

  if (!dataInicial || !dataFinal) {
    alert('Selecione um per√≠odo v√°lido.');
    return;
  }

  const inicio = new Date(dataInicial);
  const fim = new Date(dataFinal);
  fim.setHours(23, 59, 59, 999);

  const { data, error } = await supabaseClient
    .from('registros')
    .select('*')
    .eq('tipo', 'refeicoes');

  if (error) {
    console.error(error);
    alert('Erro ao buscar registros.');
    return;
  }

  const resumo = {};

  data.forEach(reg => {
    if (Array.isArray(reg.dias)) {
      reg.dias.forEach(dia => {
        const dataRef = new Date(dia.data);
        if (dataRef >= inicio && dataRef <= fim) {
          const diaStr = dataRef.toISOString().split('T')[0];
          if (!resumo[diaStr]) resumo[diaStr] = 0;
          resumo[diaStr] += parseInt(dia.qtd || 0);
        }
      });
    }
  });

  const formatarData = str => {
    const [ano, mes, dia] = str.split('-');
    return `${dia}/${mes}/${ano}`;
  };

  let texto = `üóìÔ∏è Refei√ß√µes agendadas por dia (${formatarData(dataInicial)} a ${formatarData(dataFinal)}):\n\n`;

  if (Object.keys(resumo).length === 0) {
    texto += 'Nenhum agendamento encontrado.';
  } else {
    const diasOrdenados = Object.keys(resumo).sort();
    diasOrdenados.forEach(dia => {
      const [ano, mes, diaNum] = dia.split('-');
      texto += `‚Ä¢ ${diaNum}/${mes}/${ano}: ${resumo[dia]} refei√ß√µes\n`;
    });
  }

  document.getElementById('relatorioRefeicoesPeriodo').textContent = texto;

  const link = `https://wa.me/?text=${encodeURIComponent(texto)}`;
  const whatsappBtn = document.getElementById('whatsappLinkRefeicoes');
  whatsappBtn.href = link;
  whatsappBtn.style.display = 'inline-block';
}
</script>

<script>
  function baixarRelatorioPDF() {
    const texto = document.getElementById('relatorio').textContent;
    if (!texto) return alert('Nenhum relat√≥rio para exportar.');

    const win = window.open('', '_blank');
    win.document.write('<pre>' + texto + '</pre>');
    win.document.close();
    win.focus();
    win.print();
  }

  function baixarRelatorioCSV() {
    const texto = document.getElementById('relatorio').textContent;
    if (!texto) return alert('Nenhum relat√≥rio para exportar.');

    const linhas = texto.trim().split('\n');
    let csv = '';
    linhas.forEach(l => {
      csv += `"${l.replace(/"/g, '""')}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'relatorio.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

<script>
  // Gera data de hoje no formato yyyy-mm-dd (HTML) e aplica em todos os campos de data
  const hoje = new Date();
  const dataFormatada = hoje.toISOString().split('T')[0]; // yyyy-mm-dd

  // Lista de todos os campos do tipo date que precisam ser preenchidos
  const camposData = [
    'dataRefeicao',
    'dataHospedagem',
    'dataXerox'
  ];

  // Define a data atual como valor inicial
  camposData.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) campo.value = dataFormatada;
  });

// Exibir no formato brasileiro (s√≥ no console)
  const dataBr = new Intl.DateTimeFormat('pt-BR').format(hoje);
  console.log("Data brasileira:", dataBr); // Exemplo: 03/08/2025
</script>
</body>
</html>


