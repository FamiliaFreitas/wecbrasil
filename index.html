<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Serviços - WEC Brasil</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .hidden { display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient('https://xqwubmknwvvonjzaecmk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'); // substitua com sua chave
  </script>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Registro de Serviços - WEC Brasil</h1>

    <!-- Login -->
    <div class="card mb-4" id="loginCard">
      <div class="card-header">Login</div>
      <div class="card-body">
        <form id="formLogin">
          <input type="text" class="form-control mb-2" id="loginUsuario" placeholder="Email" required>
          <div class="input-group mb-2">
             <input type="password" class="form-control" id="loginSenha" placeholder="Senha" required>
             <button type="button" class="btn btn-outline-secondary" id="toggleLoginSenha">👁️</button>
          </div>
          <button type="submit" class="btn btn-primary">Entrar</button>
        </form>
        <div class="mt-3">
          <span>Não tem conta?</span>
          <button class="btn btn-link p-0" id="btnMostrarCadastro">Cadastre-se</button>
        </div>
      </div>
    </div>

    <!-- Cadastro -->
    <div class="card mb-4 hidden" id="cadastroIndividualCard">
      <div class="card-header">Cadastro de Novo Usuário</div>
      <div class="card-body">
        <form id="formCadastroIndividual">
          <input type="email" class="form-control mb-2" id="nomeCadastroIndividual" placeholder="Email" required>
          <div class="input-group mb-2">
             <input type="password" class="form-control" id="senhaCadastroIndividual" placeholder="Senha" required>
             <button type="button" class="btn btn-outline-secondary" id="toggleCadastroSenha">👁️</button>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar</button>
          <button type="button" class="btn btn-link" id="btnVoltarLogin">Voltar ao login</button>
        </form>
      </div>
    </div>

    <!-- Área logada -->
    <div class="card mb-4 hidden" id="registroCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Registro de Uso</span>
        <div>
          <span id="usuarioLogado"></span>
          <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
        </div>
      </div>
      <div class="card-body">
        <!-- Formulários de serviços -->
        <div id="formulariosServicos">
          <form data-servico="lavanderia" class="formServico mb-3">
            <h5>Lavanderia</h5>
            <input type="text" class="form-control mb-2" placeholder="Ex: 2 cestos de roupas">
            <button class="btn btn-primary">Registrar</button>
          </form>

          <form data-servico="refeicao" class="formServico mb-3">
            <h5>Refeição</h5>
            <input type="text" class="form-control mb-2" placeholder="Ex: Almoço, 02/08">
            <button class="btn btn-primary">Registrar</button>
          </form>

          <form data-servico="carro" class="formServico mb-3">
            <h5>Carro</h5>
            <input type="text" class="form-control mb-2" placeholder="Ex: Ida ao mercado">
            <button class="btn btn-primary">Registrar</button>
          </form>

          <form data-servico="xerox" class="formServico mb-3">
            <h5>Xerox</h5>
            <input type="text" class="form-control mb-2" placeholder="Ex: 10 cópias A4">
            <button class="btn btn-primary">Registrar</button>
          </form>

          <form data-servico="hospedagem" class="formServico mb-3">
            <h5>Hospedagem</h5>
            <input type="text" class="form-control mb-2" placeholder="Ex: 2 noites, casal">
            <button class="btn btn-primary">Registrar</button>
          </form>
        </div>

        <!-- Histórico -->
        <h5>Histórico de Registros</h5>
        <ul class="list-group" id="listaRegistros"></ul>
      </div>
    </div>

    <!-- Painel Admin -->
    <div class="card mb-4 hidden" id="painelAdmin">
      <div class="card-header">Painel do Administrador</div>
      <div class="card-body">
        <div class="mb-3">Todos os registros:</div>
        <ul class="list-group" id="listaAdmin"></ul>
      </div>
    </div>
  </div>

<script>
let usuarioAtual = null;

async function verificarLogin() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  usuarioAtual = user;
  if (usuarioAtual) {
    document.getElementById('usuarioLogado').textContent = usuarioAtual.email;
    document.getElementById('loginCard').classList.add('hidden');
    document.getElementById('cadastroIndividualCard').classList.add('hidden');
    document.getElementById('registroCard').classList.remove('hidden');
    carregarRegistros();

    const { data: dadosUsuario } = await supabaseClient.from('usuarios').select('is_admin').eq('id', usuarioAtual.id).single();
    if (dadosUsuario?.is_admin) {
      document.getElementById('painelAdmin').classList.remove('hidden');
      carregarRegistrosAdmin();
    }
  }
}

verificarLogin();

document.querySelectorAll('.formServico').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const detalhes = this.querySelector('input').value;
    const servico = this.dataset.servico;
    const { error } = await supabaseClient.from('registros').insert({
      usuario_id: usuarioAtual.id,
      servico,
      data: new Date().toISOString().split('T')[0],
      detalhes: { descricao: detalhes }
    });
    if (!error) {
      this.querySelector('input').value = '';
      carregarRegistros();
      if (document.getElementById('painelAdmin').classList.contains('hidden') === false) carregarRegistrosAdmin();
    } else {
      alert('Erro ao registrar: ' + error.message);
    }
  });
});

async function carregarRegistros() {
  const { data, error } = await supabaseClient.from('registros').select('*').eq('usuario_id', usuarioAtual.id).order('data', { ascending: false });
  const lista = document.getElementById('listaRegistros');
  lista.innerHTML = '';
  if (!error) {
    data.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `${item.data} - ${item.servico}: ${item.detalhes?.descricao || ''}`;
      lista.appendChild(li);
    });
  }
}

async function carregarRegistrosAdmin() {
  const { data, error } = await supabaseClient.from('registros').select('*, usuario_id').order('data', { ascending: false });
  const lista = document.getElementById('listaAdmin');
  lista.innerHTML = '';
  if (!error) {
    data.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `${item.data} - ${item.servico} - ${item.usuario_id}: ${item.detalhes?.descricao || ''}`;
      lista.appendChild(li);
    });
  }
}

document.getElementById('formLogin').addEventListener('submit', async function (e) {
  e.preventDefault();
  const email = document.getElementById('loginUsuario').value;
  const senha = document.getElementById('loginSenha').value;
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password: senha });
  if (error) return alert('Erro no login: ' + error.message);
  location.reload();
});

document.getElementById('formCadastroIndividual').addEventListener('submit', async function(e) {
  e.preventDefault();
  const email = document.getElementById('nomeCadastroIndividual').value;
  const senha = document.getElementById('senhaCadastroIndividual').value;
  const { error } = await supabaseClient.auth.signUp({ email, password: senha });
  if (error) return alert('Erro no cadastro: ' + error.message);
  alert('Cadastro realizado! Verifique seu e-mail.');
  this.reset();
  document.getElementById('cadastroIndividualCard').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
});

document.getElementById('btnMostrarCadastro').addEventListener('click', () => {
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('cadastroIndividualCard').classList.remove('hidden');
});

document.getElementById('btnVoltarLogin').addEventListener('click', () => {
  document.getElementById('cadastroIndividualCard').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
});

async function logout() {
  await supabaseClient.auth.signOut();
  location.reload();
}

document.getElementById('toggleLoginSenha').addEventListener('click', function () {
  const input = document.getElementById('loginSenha');
  input.type = input.type === 'password' ? 'text' : 'password';
  this.textContent = input.type === 'password' ? '👁️' : '🙈';
});

document.getElementById('toggleCadastroSenha').addEventListener('click', function () {
  const input = document.getElementById('senhaCadastroIndividual');
  input.type = input.type === 'password' ? 'text' : 'password';
  this.textContent = input.type === 'password' ? '👁️' : '🙈';
});
</script>
</body>
</html>
