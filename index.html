<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Servi√ßos - WEC Brasil</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .hidden { display: none; }
  </style>
  </head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Registro de Servi√ßos - WEC Brasil</h1>   
    <!-- Login -->
    <div class="card mb-4" id="loginCard">
      <div class="card-header">Login</div>
      <div class="card-body">
        <form id="formLogin">
          <input type="text" class="form-control mb-2" id="loginUsuario" placeholder="Email" required>
          <div class="input-group mb-2">
             <input type="password" class="form-control" id="loginSenha" placeholder="Senha" required>
             <button type="button" class="btn btn-outline-secondary" id="toggleLoginSenha">üëÅÔ∏è</button>
          </div>
          <button type="submit" class="btn btn-primary">Entrar</button>
        </form>
        <div class="mt-3">
          <span>N√£o tem conta?</span>
          <button class="btn btn-link p-0" id="btnMostrarCadastro">Cadastre-se</button>
        </div>
      </div>
    </div>

    <!-- Cadastro individual -->
<div class="card mb-4 hidden" id="cadastroIndividualCard">
  <div class="card-header">Cadastro de Novo Usu√°rio</div>
  <div class="card-body">
    <form id="formCadastroIndividual">
      <input type="text" class="form-control mb-2" id="nomeCadastroIndividual" placeholder="Nome completo" required>
      <input type="email" class="form-control mb-2" id="emailCadastroIndividual" placeholder="Email" required>
      <div class="input-group mb-2">
         <input type="password" class="form-control" id="senhaCadastroIndividual" placeholder="Senha" required>
         <button type="button" class="btn btn-outline-secondary" id="toggleCadastroSenha">üëÅÔ∏è</button>
      </div>
      <button type="submit" class="btn btn-success">Cadastrar</button>
      <button type="button" class="btn btn-link" id="btnVoltarLogin">Voltar ao login</button>
    </form>
  </div>
</div>

    <!-- Cadastro de usu√°rios (somente para admin) -->
<div class="card mb-4 hidden" id="cadastroCard">
  <div class="card-header">Cadastro de Usu√°rio</div>
  <div class="card-body">
    <form id="formMissionario">
      <input type="text" class="form-control mb-2" id="nomeMissionario" placeholder="Nome do usu√°rio" required>
      <input type="email" class="form-control mb-2" id="emailMissionario" placeholder="Email" required>
      <input type="password" class="form-control mb-2" id="senhaMissionario" placeholder="Senha" required>
      <select class="form-select mb-2" id="tipoUsuario">
        <option value="comum">Usu√°rio</option>
        <option value="admin">Administrador</option>
      </select>
      <button type="submit" class="btn btn-primary">Cadastrar</button>
    </form>
  </div>
</div>
    
    <!-- Alterar senha -->
    <div class="card mb-4 hidden" id="alterarSenhaCard">
      <div class="card-header">Alterar Senha</div>
      <div class="card-body">
        <form id="formAlterarSenha">
          <input type="password" class="form-control mb-2" id="senhaAtual" placeholder="Senha atual" required>
          <input type="password" class="form-control mb-2" id="novaSenha" placeholder="Nova senha" required>
          <button type="submit" class="btn btn-warning">Alterar Senha</button>
        </form>
      </div>
    </div>

    <!-- Registro de uso de servi√ßos -->
    <div class="card mb-4 hidden" id="registroCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Registro de Uso</span>
        <div>
          <button class="btn btn-outline-secondary btn-sm" onclick="mostrarAlterarSenha()">Alterar Senha</button>
          <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
        </div>
      </div>
      <div class="card-body">
        <form id="formUso">
          <div class="mb-2"><strong>Usu√°rio logado:</strong> <span id="usuarioLogado"></span></div>
          <label>Servi√ßo:</label>
          <select id="tipoServico" class="form-select mb-2" required onchange="mostrarCamposServico()">
            <option value="">Selecione</option>
            <option value="lavanderia">Lavanderia</option>
            <option value="carro">Uso do Carro</option>
            <option value="xerox">Xerox</option>
            <option value="refeicoes">Refei√ß√µes</option>
            <option value="hospedagem">Hospedagem</option>
          </select>
          <div id="detalhesServico" class="mb-3"></div>
          <button type="submit" class="btn btn-success">Registrar Uso</button>
        </form>
      </div>
    </div>

    <!-- √Årea para relat√≥rios (somente admin) -->
    <div class="card hidden" id="relatorioCard">
      <div class="card-header">Relat√≥rio Atual</div>
      <div class="mb-3 d-flex gap-2 flex-wrap">
        <div>
           <label for="dataInicial" class="form-label">De:</label>
           <input type="date" class="form-control" id="dataInicial">
      </div>
      <div>
         <label for="dataFinal" class="form-label">At√©:</label>
         <input type="date" class="form-control" id="dataFinal">
      </div>
  </div>
      <div class="card-body">
        <button class="btn btn-info" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
        <pre id="relatorio" class="mt-3"></pre>
      </div>
    </div>
    <div>
  <div class="card hidden" id="refeicoesCard">
     <div class="card-header">Relat√≥rio de refei√ß√µes por per√≠odo</div>
     <div class="card-body">
        <div class="mb-2 d-flex gap-2 flex-wrap">
           <div>
              <label for="dataRefInicio" class="form-label">De:</label>
              <input type="date" class="form-control" id="dataRefInicio">
           </div>
           <div>
              <label for="dataRefFim" class="form-label">At√©:</label>
              <input type="date" class="form-control" id="dataRefFim">
           </div>
        </div>
        <button class="btn btn-success mb-2" onclick="gerarRelatorioRefeicoesPeriodo()">Gerar Relat√≥rio</button>
        <pre id="relatorioRefeicoesPeriodo" class="bg-light p-2 rounded"></pre>
        <a id="whatsappLinkRefeicoes" class="btn btn-outline-success" href="#" target="_blank" style="display: none;">Compartilhar via WhatsApp</a>
      </div>
    </div>
<div class="card hidden" id="gerenciarUsuariosCard">
    <div class="card-header">Gerenciar Usu√°rios</div>
    <div class="card-body">
       <ul id="listaUsuarios" class="list-group"></ul>
     </div>
  </div>
  <!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Inicializa√ß√£o segura do Supabase
  const { createClient } = window.supabase;
  const supabase = createClient(
    'https://xqwubmknwvvonjzaecmk.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxd3VibWtud3Z2b25qemFlY21rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwODY2OTQsImV4cCI6MjA2OTY2MjY5NH0._42N0mZO4NcLPcCG9YMB0_hkMTLF5tCdlPZYagN3vIk'
  );

  // Detecta usu√°rio logado e mostra os cards certos
  async function verificarLogin() {
      const { data: { user }, error } = await supabase.auth.getUser();

      if (!user) {
        document.getElementById('loginCard').classList.remove('hidden');
        return;
      }

      const { data: perfil, error: perfilError } = await supabase
        .from('usuarios')
        .select('*')
        .eq('user_id', user.id)
        .single();
    
      if (perfilError || !perfil) {
        alert('Erro ao carregar perfil: ' + (perfilError?.message || 'Perfil n√£o encontrado.'));
        await supabase.auth.signOut();
        return location.reload();
      }

      const usuarioLogado = {
        id: user.id,
        email: user.email,
        tipo: perfil.tipo,
        nome: perfil.nome
      };

      localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
      document.getElementById('usuarioLogado').textContent = usuarioLogado.nome;

      if (usuarioLogado.tipo === 'admin') {
        document.getElementById('relatorioCard')?.classList.remove('hidden');
        document.getElementById('cadastroCard')?.classList.remove('hidden');
        document.getElementById('refeicoesCard')?.classList.remove('hidden');
        document.getElementById('gerenciarUsuariosCard')?.classList.remove('hidden');
      }

      document.getElementById('registroCard')?.classList.remove('hidden');
      document.getElementById('loginCard')?.classList.add('hidden');
      document.getElementById('cadastroIndividualCard')?.classList.add('hidden');
    }

    document.getElementById('formLogin')?.addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = document.getElementById('loginUsuario').value;
      const senha = document.getElementById('loginSenha').value;

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password: senha
      });

      if (error) {
        alert('Erro ao fazer login: ' + error.message);
        return;
      }

      location.reload();
    });

document.getElementById('formCadastroIndividual')?.addEventListener('submit', async function (e) {
  e.preventDefault();

  const nome = document.getElementById('nomeCadastroIndividual').value.trim();
  const email = document.getElementById('emailCadastroIndividual').value.trim();
  const senha = document.getElementById('senhaCadastroIndividual').value;

  if (!nome || !email || !senha) {
    alert('Preencha todos os campos.');
    return;
  }

  const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
    email,
    password: senha,
    options: {
      data: {
        nome,
        tipo: 'comum'
      }
    }
  });

  if (signUpError) {
    alert('Erro ao cadastrar: ' + signUpError.message);
    return;
  }

  const userId = signUpData?.user?.id;

  if (!userId) {
    alert('Usu√°rio criado, mas n√£o foi poss√≠vel obter o ID.');
    return;
  }

  // ‚úÖ Verificar se j√° existe esse user_id na tabela 'usuarios'
  const { data: existingUser, error: fetchError } = await supabase
    .from('usuarios')
    .select('user_id')
    .eq('user_id', userId)
    .single();

  if (fetchError && fetchError.code !== 'PGRST116') {
    alert('Erro ao verificar usu√°rio existente: ' + fetchError.message);
    return;
  }

  if (!existingUser) {
    const { error: insertError } = await supabase
      .from('usuarios')
      .insert([{ user_id: userId, nome, tipo: 'comum', email }]);

    if (insertError) {
      alert('Erro ao salvar dados do usu√°rio: ' + insertError.message);
      return;
    }
  }

  alert('Cadastro realizado com sucesso. Fa√ßa login.');
  this.reset();
  document.getElementById('btnVoltarLogin')?.click();
});

verificarLogin();
</script>     
<script>
function mostrarCamposServico() {
  const tipo = document.getElementById('tipoServico').value;
  const detalhes = document.getElementById('detalhesServico');
  detalhes.innerHTML = '';

  const hoje = new Date().toISOString().split('T')[0];

  if (tipo === 'lavanderia') {
    detalhes.innerHTML = `
      <label>Data:</label>
      <input type="date" class="form-control mb-2" id="dataLavanderia" value="${hoje}">
      <label>Quantidade de lavagens:</label>
      <input type="number" class="form-control mb-2" id="qtdLavagens" min="0">
      <label>Quantidade de secagens:</label>
      <input type="number" class="form-control mb-2" id="qtdSecagens" min="0">
    `;
  } else if (tipo === 'carro') {
  detalhes.innerHTML = `
    <label>Data:</label>
    <input type="date" class="form-control mb-2" id="dataCarro" value="${hoje}">
    <label>KM Inicial:</label>
    <input type="number" class="form-control mb-2" id="kmInicial" min="0">
    <label>KM Final:</label>
    <input type="number" class="form-control mb-2" id="kmFinal" min="0">
    <label>Uso:</label>
    <select class="form-select mb-2" id="usoCarro" onchange="mostrarCampoDepartamento()">
      <option value="pessoal">Pessoal</option>
      <option value="departamento">Departamento</option>
    </select>
    <div id="campoDepartamento"></div>
    <label>Quantidade de uso da TAG:</label>
    <input type="number" class="form-control mb-2" id="qtdTag" min="0">
  `;
  } else if (tipo === 'xerox') {
    detalhes.innerHTML = `
      <label>Data:</label>
      <input type="date" class="form-control mb-2" id="dataXerox" value="${hoje}">
      <label>Quantidade de c√≥pias:</label>
      <input type="number" class="form-control mb-2" id="qtdXerox" min="1">
    `;
  } else if (tipo === 'refeicoes') {
    detalhes.innerHTML = `
      <label>Selecionar dias e quantidades:</label>
      <div id="diasRefeicoes" class="mb-2"></div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="adicionarDiaRefeicao()">Adicionar Dia</button>
    `;
  } else if (tipo === 'hospedagem') {
    detalhes.innerHTML = `
      <label>Data de entrada:</label>
      <input type="date" class="form-control mb-2" id="entrada">
      <label>Data de sa√≠da:</label>
      <input type="date" class="form-control mb-2" id="saida" onchange="validarHospedagem()">
      <div id="erroData" class="text-danger"></div>
    `;
  }
}
</script>
<script>
    function adicionarDiaRefeicao() {
  const diasContainer = document.getElementById('diasRefeicoes');
  const index = diasContainer.children.length;
  const novoDia = document.createElement('div');
  novoDia.classList.add('mb-2', 'linha-dia');
  novoDia.innerHTML = `
    <div class="d-flex align-items-center">
      <input type="date" class="form-control me-2 data-refeicao" required>
      <input type="number" class="form-control qtd-refeicao" placeholder="Quantidade" min="1" required>
      <button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">X</button>
    </div>
  `;
  diasContainer.appendChild(novoDia);
    }

    function validarHospedagem() {
      const entrada = document.getElementById('entrada').value;
      const saida = document.getElementById('saida').value;
      const erro = document.getElementById('erroData');
      if (entrada && saida && saida < entrada) {
        erro.textContent = 'A data de sa√≠da n√£o pode ser anterior √† entrada.';
      } else {
        erro.textContent = '';
      }
    }
  </script>
<script>
async function carregarUsuario() {
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user) {
    console.warn("Usu√°rio n√£o autenticado");
    return;
  }

  const { data: perfil, error: erroPerfil } = await supabase
    .from('usuarios')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (erroPerfil || !perfil) {
    alert("N√£o foi poss√≠vel carregar os dados do usu√°rio.");
    return;
  }

  document.getElementById('usuarioLogado').textContent = perfil.nome || user.email;

  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('cadastroIndividualCard').classList.add('hidden');
  document.getElementById('registroCard').classList.remove('hidden');

  if (perfil.tipo === 'admin') {
    document.getElementById('relatorioCard').classList.remove('hidden');
    document.getElementById('cadastroCard').classList.remove('hidden');
    document.getElementById('refeicoesCard').classList.remove('hidden');
    document.getElementById('gerenciarUsuariosCard').classList.remove('hidden');
    carregarListaUsuarios();
  }
}

async function carregarListaUsuarios() {
  const lista = document.getElementById('listaUsuarios');
  lista.innerHTML = '';

  const { data, error } = await supabase.auth.getSession();

  if (error || !data.session) {
    alert('Usu√°rio n√£o autenticado.');
    return;
  }

  const token = data.session.access_token;

  try {
    const res = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/listar-usuarios-seguro', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!res.ok) {
      const err = await res.text();
      alert('Erro ao carregar lista de usu√°rios: ' + err);
      return;
    }

    const usuarios = await res.json();

    usuarios.forEach((u) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <span>${u.nome || u.user_id} (${u.tipo})</span>
        <button class="btn btn-sm btn-danger" onclick="excluirUsuario('${u.user_id}')">Excluir</button>
      `;
      lista.appendChild(li);
    });
  } catch (error) {
    alert('Erro na comunica√ß√£o com o servidor: ' + error.message);
  }
}


async function excluirUsuario(user_id) {
  if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;

  const {
    data: { session },
    error: sessionError
  } = await supabase.auth.getSession();

  if (sessionError || !session) {
    alert('Usu√°rio n√£o autenticado.');
    return;
  }

  const res = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/excluir-usuario-ts', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({ user_id }),
  });

  if (!res.ok) {
    const err = await res.text();
    alert('Erro ao excluir usu√°rio: ' + err);
    return;
  }

  alert('Usu√°rio exclu√≠do com sucesso.');
  carregarListaUsuarios();
}


  // Logout com Supabase
async function logout() {
  await supabase.auth.signOut();
  localStorage.removeItem('usuarioLogado');
  location.reload();
}

// Mostrar card de altera√ß√£o de senha
function mostrarAlterarSenha() {
  document.getElementById('alterarSenhaCard').classList.remove('hidden');
}

// Alternar entre login e cadastro
document.getElementById('btnMostrarCadastro').addEventListener('click', function () {
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('cadastroIndividualCard').classList.remove('hidden');
});

document.getElementById('btnVoltarLogin').addEventListener('click', function () {
  document.getElementById('cadastroIndividualCard').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
});

// Alterar senha com Supabase
document.getElementById('formAlterarSenha').addEventListener('submit', async function (e) {
  e.preventDefault();

  const senhaAtual = document.getElementById('senhaAtual').value;
  const novaSenha = document.getElementById('novaSenha').value;

  // Tenta login para confirmar senha atual
  const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
  const { data: authData, error: loginError } = await supabase.auth.signInWithPassword({
    email: usuario.email,
    password: senhaAtual,
  });

  if (loginError) {
    alert('Senha atual incorreta.');
    return;
  }

  // Atualiza senha no Supabase
  const { error: updateError } = await supabase.auth.updateUser({
    password: novaSenha,
  });

  if (updateError) {
    alert('Erro ao alterar senha: ' + updateError.message);
    return;
  }

  alert('Senha alterada com sucesso.');
  document.getElementById('formAlterarSenha').reset();
  document.getElementById('alterarSenhaCard').classList.add('hidden');
});

document.addEventListener('DOMContentLoaded', async () => {
  const {
    data: { user }
  } = await supabase.auth.getUser();

  if (user) {
    carregarUsuario();
  } else {
    console.log('Usu√°rio n√£o autenticado');
    // Mostra tela de login, se necess√°rio
    document.getElementById('loginCard').classList.remove('hidden');
    document.getElementById('registroCard').classList.add('hidden');
  }
});
</script>
<script>
  function mostrarCampoDepartamento() {
    const uso = document.getElementById('usoCarro').value;
    const campo = document.getElementById('campoDepartamento');
    if (uso === 'departamento') {
      campo.innerHTML = `
        <label>Departamento:</label>
        <input type="text" class="form-control mb-2" id="departamento">
      `;
    } else {
      campo.innerHTML = '';
    }
  }
</script>
<script>
  function dataBRParaISO(dataBR) {
    const partes = dataBR.split('/');
    if (partes.length !== 3) return null;
    const [dia, mes, ano] = partes;
    return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
  }
  
  async function gerarRelatorio() {
    const dataInicial = document.getElementById('dataInicial').value;
    const dataFinal = document.getElementById('dataFinal').value;

    // Converter para ISO se estiver no formato brasileiro
    const dataInicialISO = dataInicial.includes('/') ? dataBRParaISO(dataInicial) : dataInicial;
    const dataFinalISO = dataFinal.includes('/') ? dataBRParaISO(dataFinal) : dataFinal;

    // Atualizar os objetos Date para os filtros internos
    const inicio = dataInicialISO ? new Date(dataInicialISO) : null;
    const fim = dataFinalISO ? new Date(dataFinalISO) : null;

    // 2. Buscar registros **APENAS UMA VEZ** com datas convertidas
    const { data: registros, error } = await supabase
     .from('registros')
     .select('*')
     .gte('data', dataInicialISO || '1900-01-01')
     .lte('data', dataFinalISO || '2999-12-31');

    if (error) {
      console.error('Erro ao buscar registros:', error);
      document.getElementById('relatorio').textContent = 'Erro ao gerar relat√≥rio.';
      return;
    }

    if (!registros || registros.length === 0) {
      document.getElementById('relatorio').textContent = 'Nenhum registro encontrado no per√≠odo selecionado.';
      return;
    }

    // 3. Gerar resumo
    const resumo = {};
    registros.forEach(reg => {
      const nome = reg.nome || reg.user_id;

      if (!resumo[nome]) {
        resumo[nome] = {
          lavanderia: 0,
          carroPessoal: 0,
          carroDepartamento: {},
          carroTag: 0,
          carroTagPorDepartamento: {},
          xerox: 0,
          refeicoes: 0,
          hospedagemDias: 0
        };
      }

      switch (reg.tipo) {
        case 'lavanderia':
          resumo[nome].lavanderia += parseInt(reg.qtdlavagens) || 0;
          break;

        case 'carro':
  const qtdTag = parseInt(reg.qtdtag) || 0;
  const kmInicial = parseInt(reg.kminicial) || 0;
  const kmFinal = parseInt(reg.kmfinal) || 0;
  const km = kmFinal - kmInicial;

  if (reg.uso === 'departamento') {
    const depto = reg.departamento || 'N√£o especificado';
    resumo[nome].carroDepartamento[depto] = (resumo[nome].carroDepartamento[depto] || 0) + km;
    resumo[nome].carroTagPorDepartamento[depto] = (resumo[nome].carroTagPorDepartamento[depto] || 0) + qtdTag;
  } else {
    resumo[nome].carroPessoal += km;
    resumo[nome].carroTag += qtdTag;
  }
  break;

        case 'xerox':
          resumo[nome].xerox += parseInt(reg.qtd) || 0;
          break;

        case 'refeicoes':
          (reg.dias || []).forEach(dia => {
            const data = new Date(dia.data);
            if ((inicio && data < inicio) || (fim && data > fim)) return;
            resumo[nome].refeicoes += parseInt(dia.qtd) || 0;
          });
          break;

        case 'hospedagem':
          const entrada = new Date(reg.entrada);
          const saida = new Date(reg.saida);
          if ((inicio && saida < inicio) || (fim && entrada > fim)) return;
          const dias = Math.ceil((saida - entrada) / (1000 * 60 * 60 * 24));
          if (dias > 0) resumo[nome].hospedagemDias += dias;
          break;
      }
    });

    // 4. Gerar texto final
    let texto = '';
    for (let nome in resumo) {
      const r = resumo[nome];
      texto += `Usu√°rio: ${nome}\n`;

      texto += `- Carro (uso pessoal): ${r.carroPessoal} km rodados\n`;
      texto += `- Carro (por departamento):\n`;
      for (let depto in r.carroDepartamento) {
        texto += `    ‚Ä¢ ${depto}: ${r.carroDepartamento[depto]} km rodados\n`;
      }

      texto += `- Uso da TAG (total): ${r.carroTag} uso(s)\n`;
      if (Object.keys(r.carroTagPorDepartamento).length > 0) {
        texto += `- Uso da TAG por departamento:\n`;
        for (let depto in r.carroTagPorDepartamento) {
          texto += `    ‚Ä¢ ${depto}: ${r.carroTagPorDepartamento[depto]} uso(s)\n`;
        }
      }

      texto += `- Lavanderia: ${r.lavanderia} lavagem(ns)\n`;
      texto += `- Xerox: ${r.xerox} c√≥pia(s)\n`;
      texto += `- Refei√ß√µes: ${r.refeicoes} refei√ß√£o(√µes)\n`;
      texto += `- Hospedagem: ${r.hospedagemDias} dia(s)\n\n`;
    }

    document.getElementById('relatorio').textContent = texto;
  }
</script>
<script>
  async function prepararRegistro() {
  // üß† Recuperar o usu√°rio logado
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) {
    alert('Usu√°rio n√£o autenticado');
    return;
  }

  const tipo = document.getElementById('tipoServico').value;
  const hoje = new Date().toISOString().split('T')[0];

  const registro = {
    user_id: user.id, // ESSENCIAL para RLS permitir o insert
    tipo,
    data: hoje
  };

    // Resto do seu c√≥digo continua normalmente
  if (tipo === 'lavanderia') {
    const lavagens = document.getElementById('qtdLavagens').value;
    const secagens = document.getElementById('qtdSecagens').value;
    const data = document.getElementById('dataLavanderia').value;

    if (!lavagens || !secagens) return alert('Preencha a quantidade de lavagens e secagens.');
    if (!data) return alert('Informe a data.');
    
    registro.qtdlavagens = parseInt(lavagens);
    registro.qtdsecagens = parseInt(secagens);
    registro.data = data;

  } else if (tipo === 'carro') {
    const kmInicial = document.getElementById('kmInicial').value;
    const kmFinal = document.getElementById('kmFinal').value;
    const qtdTag = document.getElementById('qtdTag').value;
    const uso = document.getElementById('usoCarro').value;
    const data = document.getElementById('dataCarro').value;

    if (!kmInicial || !kmFinal || isNaN(kmInicial) || isNaN(kmFinal)) {
      return alert('Informe os km inicial e final.');
    }
    if (!data) return alert('Informe a data.');

    registro.kminicial = parseInt(kmInicial);
    registro.kmfinal = parseInt(kmFinal);
    registro.qtdtag = parseInt(qtdTag) || 0;
    registro.uso = uso;
    registro.data = data;

    if (uso === 'departamento') {
      const departamento = document.getElementById('departamento').value;
      if (!departamento) return alert('Informe o nome do departamento.');
      registro.departamento = departamento;
    }

  } else if (tipo === 'xerox') {
    const qtd = document.getElementById('qtdXerox').value;
    const data = document.getElementById('dataXerox').value;

    if (!qtd) return alert('Informe a quantidade de c√≥pias.');
    if (!data) return alert('Informe a data.');

    registro.qtd = parseInt(qtd);
    registro.data = data;

  } else if (tipo === 'refeicoes') {
    const dias = [];
    let erro = false;

    document.querySelectorAll('.linha-dia').forEach(el => {
      const data = el.querySelector('.data-refeicao').value;
      const qtd = el.querySelector('.qtd-refeicao').value;
      if (!data || !qtd) erro = true;
      dias.push({ data, qtd: parseInt(qtd) });
    });

    if (erro || dias.length === 0) return alert('Preencha todos os dias e quantidades de refei√ß√µes.');
    registro.dias = dias;

  } else if (tipo === 'hospedagem') {
    const entrada = document.getElementById('entrada').value;
    const saida = document.getElementById('saida').value;

    if (!entrada || !saida) return alert('Preencha as datas de entrada e sa√≠da.');
    if (saida < entrada) return alert('A data de sa√≠da n√£o pode ser anterior √† entrada.');

    registro.entrada = entrada;
    registro.saida = saida;
  }

  // üü¢ Insere no Supabase
  const { error } = await supabase.from('registros').insert([registro]);

  if (error) {
    console.error('Erro ao salvar registro:', error);
    alert('Erro ao salvar registro. Verifique os dados e tente novamente.');
  } else {
    alert('Registro salvo com sucesso!');
document.getElementById('formUso').reset();
document.getElementById('tipoServico').value = ''; // volta o select
mostrarCamposServico(); // limpa os campos adicionais

const campoDepartamento = document.getElementById('campoDepartamento');
if (campoDepartamento) campoDepartamento.innerHTML = '';
  }
}

  
  document.getElementById('formUso').addEventListener('submit', function (e) {
    e.preventDefault();
    prepararRegistro();
  });
</script>
<script>
  async function gerarRelatorioRefeicoesPeriodo() {
    const dataInicial = document.getElementById('dataRefInicio').value;
    const dataFinal = document.getElementById('dataRefFim').value;

    if (!dataInicial || !dataFinal) {
      alert('Selecione um per√≠odo v√°lido.');
      return;
    }

    const inicio = new Date(dataInicial);
    const fim = new Date(dataFinal);
    fim.setHours(23, 59, 59, 999); // incluir o √∫ltimo dia inteiro

    // Busca registros de refei√ß√µes no per√≠odo
    const { data: registros, error } = await supabase
      .from('registros')
      .select('*')
      .eq('tipo', 'refeicoes');

    if (error) {
      console.error('Erro ao buscar registros:', error);
      alert('Erro ao carregar os registros.');
      return;
    }

    if (!registros || registros.length === 0) {
      alert('Nenhum registro de refei√ß√µes encontrado.');
      return;
    }

    const resumo = {};

    registros.forEach(reg => {
      if (Array.isArray(reg.dias)) {
        reg.dias.forEach(dia => {
          const data = new Date(dia.data);
          if (data >= inicio && data <= fim) {
            const diaStr = data.toISOString().split('T')[0];
            if (!resumo[diaStr]) resumo[diaStr] = 0;
            resumo[diaStr] += parseInt(dia.qtd || 0);
          }
        });
      }
    });

    const formatarData = str => {
      const [ano, mes, dia] = str.split('-');
      return `${dia}/${mes}/${ano}`;
    };

    let texto = `üóìÔ∏è Refei√ß√µes agendadas por dia (${formatarData(dataInicial)} a ${formatarData(dataFinal)}):\n\n`;

    if (Object.keys(resumo).length === 0) {
      texto += 'Nenhum agendamento encontrado.';
    } else {
      const diasOrdenados = Object.keys(resumo).sort();
      diasOrdenados.forEach(dia => {
        const [ano, mes, diaNum] = dia.split('-');
        texto += `‚Ä¢ ${diaNum}/${mes}/${ano}: ${resumo[dia]} refei√ß√µes\n`;
      });
    }

    document.getElementById('relatorioRefeicoesPeriodo').textContent = texto;

    const link = `https://wa.me/?text=${encodeURIComponent(texto)}`;
    const whatsappBtn = document.getElementById('whatsappLinkRefeicoes');
    whatsappBtn.href = link;
    whatsappBtn.style.display = 'inline-block';
  }
</script>
<script>
  document.getElementById('formMissionario').addEventListener('submit', async function (e) {
  e.preventDefault();

  const nome = document.getElementById('nomeMissionario').value.trim();
  const email = document.getElementById('emailMissionario').value.trim();
  const senha = document.getElementById('senhaMissionario').value;
  const tipo = document.getElementById('tipoUsuario').value;

  if (!nome || !email || !senha || !tipo) {
    alert('Preencha todos os campos.');
    return;
  }

  try {
    const { data: sessionData, error } = await supabase.auth.getSession();
    const token = sessionData?.session?.access_token;

    if (!token) {
      alert('Usu√°rio n√£o autenticado.');
      return;
    }

    const response = await fetch('https://xqwubmknwvvonjzaecmk.functions.supabase.co/criar-usuario-ts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ nome, email, senha, tipo })
    });

    if (!response.ok) {
      const errorText = await response.text();
      alert('Erro ao cadastrar: ' + errorText);
      return;
    }

    alert('Usu√°rio cadastrado com sucesso!');
    document.getElementById('formMissionario').reset();

    if (typeof carregarListaUsuarios === 'function') {
      carregarListaUsuarios();
    }

  } catch (error) {
    alert('Erro ao cadastrar: ' + error.message);
  }
});
</script>
</body>
</html>































